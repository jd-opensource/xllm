syntax = "proto3";

option go_package = "jd.com/jd-infer/xllm;xllm";
package xllm.proto;
option cc_enable_arenas = true;
option cc_generic_services = true;

import "common.proto";

// Request for KV tensor mapping with model_id and offsets
message KvTensorRequest {
  string model_id = 1;
  repeated uint64 offsets = 2;
}

// Response for memory info query
// Returns 0 for both fields on failure
message MemoryInfoResponse {
  int64 available_memory = 1;  // Available memory in bytes
  int64 total_memory = 2;      // Total memory in bytes
}

// Request for initializing PhyPagePool
message InitPhyPagePoolRequest {
  int64 num_pages = 1;  // Number of physical pages to allocate
}

// Request for allocating weight pages from GlobalXTensor
message AllocWeightPagesRequest {
  string model_id = 1;
  uint64 num_pages = 2;  // Number of pages to allocate
}

// Response for weight pages allocation (just success/failure)

// Request for freeing weight pages
message FreeWeightPagesRequest {
  string model_id = 1;
}

// Request for getting XTensor offsets for KV cache blocks
message GetXTensorOffsetsRequest {
  string model_id = 1;
  repeated int32 block_ids = 2;
  uint64 block_size_bytes = 3;
}

// Per-layer K/V offsets for XTensor
message XTensorLayerOffsetsProto {
  repeated uint64 k_offsets = 1;
  repeated uint64 v_offsets = 2;
}

// Response for XTensor offsets
message GetXTensorOffsetsResponse {
  // Per-layer offsets: layer_offsets[layer_id] contains K/V offsets for all blocks
  repeated XTensorLayerOffsetsProto layer_offsets = 1;
}

// XTensorDist service for distributed XTensor mapping operations
service XTensorDist {
  rpc Hello (Status) returns (Status);
  
  // Memory info query (called before init to get available memory)
  rpc GetMemoryInfo (Status) returns (MemoryInfoResponse);
  
  // Initialize PhyPagePool with specified number of pages
  rpc InitPhyPagePool (InitPhyPagePoolRequest) returns (Status);
  
  // KV tensor operations (partial mapping by offsets)
  // KV XTensor is created on first map if not exists
  // Size = PhyPagePool::num_total() * page_size
  rpc MapToKvTensors (KvTensorRequest) returns (Status);
  rpc UnmapFromKvTensors (KvTensorRequest) returns (Status);
  
  // Weight pages allocation from GlobalXTensor
  rpc AllocWeightPages (AllocWeightPagesRequest) returns (Status);
  rpc FreeWeightPages (FreeWeightPagesRequest) returns (Status);
  
  // Get XTensor offsets for KV cache blocks (used in PD disaggregation)
  // Returns GlobalXTensor offsets for each block at each layer
  rpc GetXTensorOffsets (GetXTensorOffsetsRequest) returns (GetXTensorOffsetsResponse);
}
